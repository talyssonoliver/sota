#!/usr/bin/env bash
set -e

LOG_FILE=".git/hooks/post-commit.log"
BACKUP_DIR="backups"
mkdir -p "$BACKUP_DIR"

exec > >(tee -a "$LOG_FILE") 2>&1

echo "[post-commit] $(date) - starting automation"

# Run asynchronously to avoid delaying commit
(
    changed_py=$(git diff-tree -r --name-only --no-commit-id HEAD~1 HEAD | grep -E '\.py$' || true)
    if [[ -n "$changed_py" ]]; then
        if command -v pdoc >/dev/null 2>&1; then
            echo "Generating API docs for changed modules..."
            pdoc $changed_py --output-dir docs/api >/dev/null || echo "pdoc failed"
        fi
        if [ -f README.md ]; then
            sed -i '/^Last Updated:/d' README.md
            echo "Last Updated: $(date -u)" >> README.md
        fi
    fi

    # Backup repo
    ts=$(date +%Y%m%d_%H%M%S)
    tar -czf "$BACKUP_DIR/sota_$ts.tar.gz" . >/dev/null 2>&1
    (ls -1t $BACKUP_DIR/sota_*.tar.gz | tail -n +8 | xargs -r rm --) || true

    echo "[post-commit] automation finished"
) &
